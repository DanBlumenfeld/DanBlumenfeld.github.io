<!DOCTYPE html>
<html>
  <head>
    <title>Property Boundaries</title>
    <style>
        /* Ensure html and body take up full height */
        html, body {
          height: 100%;
          margin: 0;
        }
  
        /* Set the map container to take up the full height */
        #map {
          height: 100%;
          width: 100%;
        }
      </style>
  </head>
  <body>
    <div id="map"></div>
    <script>

      let map;
      let userMarker; 
      const initialPosition = { lat: 39.8264229, lng: -76.4800349 };

      // Haversine formula to calculate distance between two coordinates
      function haversine(lat1, lon1, lat2, lon2) {
        const R = 3958.8; // Radius of Earth in miles
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c; // Distance in miles
      }

      function initMap() {
        try {
          // Create a new Google Map
          map = new google.maps.Map(document.getElementById('map'), {
            center: initialPosition,
            zoom: 15
          });
          
          console.log('Map initialized successfully');
        } catch (error) {
          console.error('Error initializing map:', error);
        }      

        // Load GeoJSON files
        map.data.loadGeoJson('/assets/muddycreekforksrd/Tax_Parcel_46C0.geojson');
        map.data.loadGeoJson('/assets/muddycreekforksrd/Tax_Parcel_46A0.geojson');

        // Optionally, style the GeoJSON layer
        map.data.setStyle({
          fillColor: 'green',
          strokeWeight: 2,
          strokeColor: 'blue',
        });

        // Try to get the user's current location
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            function(position) {
              const userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
              };

              // Calculate the distance between the initial position and the user's location
              const distance = haversine(initialPosition.lat, initialPosition.lng, userLocation.lat, userLocation.lng);

              // If the distance is less than 1 mile, recenter the map on the user's location
              if (distance <= 1) {
                map.setCenter(userLocation);
                map.setZoom(15);                
                }
               
              refreshUserLocation()

              console.log('Current location:', userLocation);
              console.log('Distance from initial position:', distance, 'miles');
            },
            function(error) {
              console.error('Error getting location:', error);
              alert('Unable to retrieve your location');
            }
          );
        } else {
          alert('Geolocation is not supported by this browser.');
        }   

      }

      // Function to refresh user location every minute
      function refreshUserLocation() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            function(position) {
              const userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
              };

              if (!userMarker) {
                  userMarker = new google.maps.Marker({
                    position: userLocation,
                    map: map,
                    title: 'You are here'
                  });
              }

              // Update the marker's position without recentering the map
              if (userMarker) {
                userMarker.setPosition(userLocation);
              }

              console.log('Updated location:', userLocation);
            },
            function(error) {
              console.error('Error getting location:', error);
              alert('Unable to retrieve your location');
            }
          );
        } else {
          alert('Geolocation is not supported by this browser.');
        }
      }      

      function loadGoogleMaps() {
        var script = document.createElement('script');
        script.src = "https://maps.googleapis.com/maps/api/js?key=AIzaSyAB7pYi3u85SYBI1ViEB_Og2jhKaZgdtGw&callback=initMap";
        script.async = true;
        script.defer = true;
        document.body.appendChild(script);
      }

      loadGoogleMaps();

      setInterval(refreshUserLocation, 30000); //in milliseconds

    </script>
  </body>
</html>
